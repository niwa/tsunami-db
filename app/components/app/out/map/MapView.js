define(["jquery","underscore","backbone","leaflet","esri.leaflet","leaflet.rrose","leaflet.draw","./mapControl/MapControlView","./mapControl/MapControlModel","./mapPlot/mapPlotLat/MapPlotLatView","./mapPlot/MapPlotModel","text!./map.html","text!./mapPopupMultipeRecords.html"],function(e,t,o,i,s,a,l,n,r,d,u,h,p){return o.View.extend({events:{"click .layer-select":"layerSelect","mouseenter .layer-select":"layerMouseOver","mouseleave .layer-select":"layerMouseOut","click .toggle-option":"toggleOptionClick","click .nav-link":"handleNavLink"},initialize:function(){this.handleActive(),this.viewUpdating=!1,this.views=this.model.getViews(),this.render(),this.listenTo(this.model,"change:active",this.handleActive),this.listenTo(this.model,"change:view",this.handleViewUpdate),this.listenTo(this.model,"change:outColorColumn",this.updateViews),this.listenTo(this.model,"change:outPlotColumns",this.updateViews),this.listenTo(this.model,"change:outType",this.updateViews),this.listenTo(this.model,"change:invalidateSize",this.invalidateSize),this.listenTo(this.model,"change:popupLayers",this.popupLayersUpdated),this.listenTo(this.model,"change:selectedLayerId",this.selectedLayerUpdated),this.listenTo(this.model,"change:mouseOverLayerId",this.mouseOverLayerUpdated),this.listenTo(this.model,"change:recordsUpdated",this.recordsUpdated),this.listenTo(this.model,"change:geoQuery",this.updateGeoQuery)},render:function(){return this.$el.html(t.template(h)({t:this.model.getLabels()})),this.configureMap(),this.updateViews(),this.initDraw(),this},initDraw:function(){var o=this.model.getMap(),i=new L.Control.Draw({draw:{rectangle:!0,polyline:!1,polygon:!1,marker:!1,circle:!1},edit:!1}),s=this.model.getLabels();L.drawLocal.draw.toolbar.buttons.rectangle=s.out.map.draw.draw,L.drawLocal.draw.handlers.rectangle.tooltip.start=s.out.map.draw.start,L.drawLocal.draw.handlers.simpleshape.tooltip.end=s.out.map.draw.end,o.addControl(i),this.$(".leaflet-draw-toolbar .leaflet-draw-draw-rectangle").html('<span class="icon-icon_draw"></span>'),o.on("draw:created",t.bind(this.onDrawCreated,this)),o.on("draw:drawstart",t.bind(this.onDrawStart,this));var a=this,l=L.Control.extend({options:{position:"topleft"},onAdd:function(){var o=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-delete"),i=L.DomUtil.create("a","",o);return e(i).attr("href","#"),e(i).attr("title",s.out.map.draw.clear),L.DomUtil.create("span","icon-icon_draw-reset",i),i.onclick=t.bind(a.queryDeleteClicked,a),o}});this.model.set("queryDeleteControl",new l)},initMapControlView:function(){this.$("#map-control").length>0&&(this.views.control=this.views.control||new n({el:this.$("#map-control"),model:new r({labels:this.model.getLabels(),columnCollection:this.model.get("columnCollection"),active:!1})}))},initMapPlotLatView:function(){if(this.$("#map-plot-lat").length>0){var e=this.model.get("columnCollection").byAttribute("plot");this.views.plotLat=this.views.plotLat||new d({el:this.$("#map-plot-lat"),model:new u({labels:this.model.getLabels(),columnCollection:e,currentRecordCollection:[],mouseOverLayerId:"",selectedLayerId:"",active:!1,outPlotColumns:t.pluck(e.models,"id")})})}},updateMapPlotLatView:function(){if(this.views.plotLat.model.set({outPlotColumns:void 0!==this.model.getOutPlotColumns()?this.model.getOutPlotColumns():t.pluck(this.model.get("columnCollection").byAttribute("plot").models,"id")}),void 0!==this.model.getCurrentRecords()){var e=this.model.getMap().getBounds().getNorthEast(),o=this.model.getMap().getBounds().getSouthWest();this.views.plotLat.model.setCurrentRecords(this.model.getCurrentRecords().byBounds({north:e.lat,east:e.lng,south:o.lat,west:o.lng}).models)}},updateMapControlView:function(){this.views.control.model.set({outColorColumn:this.model.getOutColorColumn()})},updateViews:function(){switch(this.$("#map-options button").removeClass("active"),this.$('#map-options [data-option="'+this.model.getOutType()+'"]').addClass("active"),this.model.getOutType()){case"control":this.$el.removeClass("full-width"),this.initMapControlView(),this.views.plotLat&&this.views.plotLat.model.setActive(!1),this.views.control.model.setActive(),this.updateMapControlView();break;case"plot-lat":this.$el.removeClass("full-width"),this.initMapPlotLatView(),this.views.control&&this.views.control.model.setActive(!1),this.views.plotLat.model.setActive(),this.updateMapPlotLatView();break;default:this.$el.addClass("full-width"),this.views.control&&this.views.control.model.setActive(!1),this.views.plotLat&&this.views.plotLat.model.setActive(!1)}this.invalidateSize(!0)},configureMap:function(){var e=this.model.getConfig(),o=L.map(e.mapID,e.mapOptions).on("popupclose",t.bind(this.onPopupClose,this)).on("zoomstart",t.bind(this.onZoomStart,this)).on("movestart",t.bind(this.onMoveStart,this)).on("zoomend",t.bind(this.onZoomEnd,this)).on("moveend",t.bind(this.onMoveEnd,this)).on("resize",t.debounce(t.bind(this.resize,this),500)),i=L.control.attribution({position:"bottomright"}).setPrefix("").addAttribution(e.attribution);o.addControl(i),this.model.setMap(o),this.initLayerGroups(),this.model.mapConfigured(!0),this.$el.trigger("mapConfigured")},initLayerGroups:function(){var e=this.model.getMap(),o=this.model.getConfig(),i={};t.each(o.layerGroups,function(t,o){var s=new L.layerGroup;i[o]=s,s.addTo(e)}),this.model.setLayerGroups(i),t.each(this.model.getLayers().models,function(e){e.setLayerGroup(this.model.getLayerGroup("default"))},this),t.each(o.layerGroups,function(e,o){"default"!==o&&t.each(this.model.getLayers().where(e),function(e){e.setLayerGroup(this.model.getLayerGroup(o)),"base"===o&&e.addToMap()},this)},this)},updateMapView:function(){var e=this.model.getView(),t=this.model.getMap();if(null!==e&&"string"==typeof e&&(e=this.model.getConfigView(e)),null!==e&&void 0!==e)if(void 0!==e.center&&void 0!==e.zoom&&void 0!==e.dimensions)if(this.model.mapConfigured()){var o=this.getZoomForDimensions(e);t.getZoom()===o&&this.roundDegrees(t.getCenter().lat)===e.center.lat&&this.roundDegrees(t.getCenter().lng)===e.center.lng||t.setView(e.center,o,{animate:!0})}else this.zoomToDefault();else void 0!==e.south&&void 0!==e.west&&void 0!==e.north&&void 0!==e.east?t.fitBounds([[e.south,e.west],[e.north,e.east]]):this.zoomToDefault();else this.zoomToDefault();this.updateViews(),this.triggerMapViewUpdated()},zoomToDefault:function(){var e=this.model.getDefaultView();this.model.getMap().setView(e.center,this.getZoomForDimensions(e),{animate:!0})},recordsUpdated:function(){this.updateViews()},handleActive:function(){if(this.model.isActive()){this.$el.show();var e=this;waitFor(function(){return e.model.mapConfigured()},function(){e.invalidateSize(!1)})}else this.$el.hide()},handleViewUpdate:function(){var e=this;waitFor(function(){return e.model.mapConfigured()},function(){e.updateMapView()})},mouseOverLayerUpdated:function(){"plot-lat"===this.model.getOutType()&&this.views.plotLat&&this.views.plotLat.model.set("mouseOverRecordId",this.model.get("mouseOverLayerId"))},selectedLayerUpdated:function(){this.updatePopupContent(),"plot-lat"===this.model.getOutType()&&this.views.plotLat&&this.views.plotLat.model.set("selectedRecordId",this.model.get("selectedLayerId"))},popupLayersUpdated:function(){var e=this.model.get("popupLayers"),t=this.model.getMap();if(t.closePopup(),e.length>0){var o=e[0],i=new L.Rrose({offset:new L.Point(0,-4),closeButton:!1,autoPan:!1}).setContent(this.getMultiplesPopupContent()).setLatLng(o.layer.getLayers()[0].getLatLng()).openOn(t);this.model.set("multipleTooltip",i)}},updatePopupContent:function(){void 0!==this.model.get("multipleTooltip")&&null!==this.model.get("multipleTooltip")&&this.model.get("multipleTooltip").setContent(this.getMultiplesPopupContent())},getMultiplesPopupContent:function(){var e=this.model.get("popupLayers");return t.template(p)({layers:t.map(e,function(e){var t=e.color.colorToRgb();return{label:e.label,color:e.color,fillColor:"rgba("+t[0]+","+t[1]+","+t[2]+",0.4)",id:e.id,selected:this.model.get("selectedLayerId")===e.id,mouseOver:this.model.get("mouseOverLayerId")===e.id}},this)})},updateGeoQuery:function(){var e=this.model.get("geoQuery"),t=this.model.get("queryLayer"),o=this.model.get("queryDeleteControl"),i=this.model.getLayerGroups().default,s=this.model.getMap();void 0!==t&&i.hasLayer(t)&&i.removeLayer(t),void 0!==o&&o.remove(),void 0!==e&&(void 0===e.north&&void 0===e.south&&void 0===e.west&&void 0===e.east||(t=L.rectangle(L.latLngBounds(L.latLng(void 0!==e.south?parseFloat(e.south):-90,void 0!==e.west?e.west<0?parseFloat(e.west)+360:parseFloat(e.west):0),L.latLng(void 0!==e.north?parseFloat(e.north):90,void 0!==e.east?e.east<0?parseFloat(e.east)+360:parseFloat(e.east):360)),this.model.getConfig().layerStyles.query),i.addLayer(t),t.bringToBack(),this.model.set("queryLayer",t),s.addControl(o)))},resize:function(){this.updateMapView()},invalidateSize:function(e){e=void 0!==e&&e,void 0!==this.model.getMap()&&this.model.getMap().invalidateSize(e)},onPopupClose:function(e){this.model.set("multipleTooltip",null),this.$el.trigger("mapPopupClosed")},onZoomStart:function(e){this.zooming=!0},onMoveStart:function(e){this.moving=!0},onZoomEnd:function(e){this.zooming=!1,this.triggerMapViewUpdated()},onMoveEnd:function(e){this.moving=!1,this.triggerMapViewUpdated()},triggerMapViewUpdated:function(){var e=this.model.getMap();if(!this.viewUpdating){var o=this;this.viewUpdating=!0,waitFor(function(){return o.model.mapConfigured()&&null!==o.model.getView()},function(){o.viewUpdating=!1;var i=o.model.getView();void 0===i||i.zoom===e.getZoom()&&i.center.lat===o.roundDegrees(e.getCenter().lat)&&i.center.lng===o.roundDegrees(e.getCenter().lng)&&t.isEqual(i.dimensions,o.getDimensions())||o.$el.trigger("mapViewUpdated",{view:{zoom:e.getZoom(),center:{lat:o.roundDegrees(e.getCenter().lat),lng:o.roundDegrees(e.getCenter().lng)},dimensions:o.getDimensions()}})})}},queryDeleteClicked:function(e){e.preventDefault(),this.$el.trigger("geoQueryDelete")},layerSelect:function(t){t.preventDefault(),this.$el.trigger("mapLayerSelect",{id:e(t.currentTarget).attr("data-layerid")})},layerMouseOver:function(t){t.preventDefault(),this.$el.trigger("mapLayerMouseOver",{id:e(t.currentTarget).attr("data-layerid")})},layerMouseOut:function(t){t.preventDefault(),this.$el.trigger("mapLayerMouseOut",{id:e(t.currentTarget).attr("data-layerid")})},toggleOptionClick:function(t){t.preventDefault(),this.$el.trigger("mapOptionToggled",{option:e(t.currentTarget).attr("data-option")})},onDrawStart:function(t){var o=this.model.getMap();o.closePopup(),e(o.getPane("popupPane")).hide()},onDrawCreated:function(t){var o=this.model.getMap();o.closePopup(),e(o.getPane("popupPane")).show(),this.$el.trigger("geoQuerySubmit",{geoQuery:{north:this.roundDegrees(t.layer.getBounds().getNorth()),south:this.roundDegrees(t.layer.getBounds().getSouth()),west:this.roundDegrees(t.layer.getBounds().getWest()),east:this.roundDegrees(t.layer.getBounds().getEast())}}),o.fitBounds(t.layer.getBounds())},handleNavLink:function(t){t.preventDefault(),t.stopPropagation();var o=e(t.target).data("id"),i=e(t.target).data("route"),s=e(t.target).data("type");this.$el.trigger("navLink",{target:t.target,id:o,route:i,type:s})},getDimensions:function(){return[this.$el.innerWidth(),this.$el.innerHeight()]},getZoomOffset:function(e){var t=this.getDimensions(),o=[e.dimensions[0],e.dimensions[1]],i=1,s=0,a=1;if(1===(i=t[0]/t[1]>o[0]/o[1]?t[1]/o[1]:t[0]/o[0]))return s;if(i>1)for(;1.9*a<i;)a*=2,s++;else for(var s=0,a=1;a>i;)a/=2,s--;return s},getZoomForDimensions:function(e){var t=this.model.getMap();return Math.max(Math.min(e.zoom+this.getZoomOffset(e),t.getMaxZoom()),t.getMinZoom())},setZoomClass:function(){this.$el.removeClass(function(e,t){return(t.match(/\bzoom-level-\S+/g)||[]).join(" ")}),this.$el.addClass("zoom-level-"+this.model.getZoom())},roundDegrees:function(e){return Math.round(1e4*e)/1e4}})});