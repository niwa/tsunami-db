define(["jquery","underscore","backbone","bootstrap","./map/MapView","./map/MapModel","./table/TableView","./table/TableModel","text!./out.html","text!./out_nav.html","text!./out_data.html","text!./out_navInfo.html","text!./out_navReset.html","ga"],function(e,t,i,o,s,a,l,d,r,h,n,u,m,c){return i.View.extend({events:{"click .toggle-view":"toggleView","click .toggle-data":"toggleData","click .close-data":"closeData","click .query-reset":"queryReset","click .download-data":"downloadData"},initialize:function(){this.views=this.model.getViews(),this.render(),this.listenTo(this.model,"change:active",this.handleActive),this.listenTo(this.model,"change:mapView",this.updateMapViewView),this.listenTo(this.model,"change:outType",this.updateOutType),this.listenTo(this.model,"change:outMapType",this.updateOutMapType),this.listenTo(this.model,"change:outColorColumn",this.updateOutColorColumn),this.listenTo(this.model,"change:outPlotColumns",this.updateOutPlotColumns),this.listenTo(this.model,"change:tableSortColumn",this.updateTableSortColumn),this.listenTo(this.model,"change:tableSortOrder",this.updateTableSortOrder),this.listenTo(this.model,"change:recordsUpdated",this.updateRecords),this.listenTo(this.model,"change:recordId",this.updateSelectedRecord),this.listenTo(this.model,"change:recordMouseOverId",this.updateMouseOverRecord),this.listenTo(this.model,"change:recordsPopup",this.recordsPopup),this.listenTo(this.model,"change:queryLength",this.updateQueryLength),this.listenTo(this.model,"change:geoQuery",this.updateGeoQuery),this.listenTo(this.model,"change:query",this.updateQuery),this.listenTo(this.model,"change:dataToggled",this.renderData)},render:function(){return this.$el.html(t.template(r)({t:this.model.getLabels()})),this.renderHeader(),this.renderHeaderInfo(),this.renderHeaderReset(),this.updateHeaderActive(),this.updateViews(),this},updateViews:function(){switch(this.model.getOutType()){case"map":this.initMapView(),this.views.table&&this.views.table.model.setActive(!1),this.views.map.model.setActive(),this.updateMapView();break;case"table":this.initTableView(),this.views.map&&this.views.map.model.setActive(!1),this.views.table.model.setActive(),this.updateTableView()}},renderHeader:function(){this.$("nav").html(t.template(h)({t:this.model.getLabels()}))},renderHeaderInfo:function(){var e=this.model.getRecords().byActive();this.$("nav .out-nav-info").html(t.template(u)({t:this.model.getLabels(),filtered:this.model.get("queryLength")>0,record_no:void 0!==e?e.length:0}))},renderHeaderReset:function(){this.model.get("queryLength")>0?this.$("nav .out-nav-reset").html(t.template(m)({t:this.model.getLabels(),count:this.model.get("queryLength")})):this.$("nav .out-nav-reset").html("")},updateHeaderActive:function(e){e=void 0!==e?e:this.model.getOutType(),this.$("nav .toggle-btn").removeClass("active"),this.$("nav .toggle-"+e).addClass("active")},updateRecords:function(){this.renderHeaderInfo(),this.updateViews(),this.renderData()},updateOutType:function(){this.updateHeaderActive(),this.updateViews()},updateQueryLength:function(){this.renderHeaderReset()},canDownload:function(){return(-1==navigator.userAgent.indexOf("Safari")||-1!=navigator.userAgent.indexOf("Chrome"))&&Modernizr.blobconstructor},renderData:function(){this.model.get("dataToggled")?(this.$("#data-view").html(t.template(n)({t:this.model.getLabels(),filtered:this.model.get("queryLength")>0,canDownload:this.canDownload(),download:{formats:[{id:"download-csv",title:this.model.getLabels().out.data.formats.csv,format:"csv"}],tables:[{id:"records",title:this.model.getLabels().out.data.tables.records},{id:"proxies",title:this.model.getLabels().out.data.tables.proxies},{id:"references",title:this.model.getLabels().out.data.tables.references}]},api:{formats:[{id:"api-xml",title:this.model.getLabels().out.data.formats.xml,format:"xml",path:""},{id:"api-json",title:this.model.getLabels().out.data.formats.json,format:"json",path:"&outputFormat=text/javascript"},{id:"api-csv",title:this.model.getLabels().out.data.formats.csv,format:"csv",path:"&outputFormat=csv"}],tables:[{title:this.model.getLabels().out.data.tables.records,path:this.model.get("paths").records},{title:this.model.getLabels().out.data.tables.proxies,path:this.model.get("paths").proxies},{title:this.model.getLabels().out.data.tables.references,path:this.model.get("paths").references}]}})),this.$("#data-view .nav-tabs a").click(function(t){t.preventDefault(),e(this).tab("show")}),this.$("#data-view .select-on-click").on("click",this.selectOnClick)):this.$("#data-view").html("")},initTableView:function(){this.$("#table").length>0&&(this.views.table=this.views.table||new l({el:this.$("#table"),model:new d({labels:this.model.getLabels(),columnCollection:this.model.get("columnCollection").byAttribute("table"),columnGroupCollection:this.model.get("columnGroupCollection"),tableSortColumn:void 0!==this.model.get("tableSortColumn")?this.model.get("tableSortColumn"):"id",tableSortOrder:void 0!==this.model.get("tableSortOrder")?this.model.get("tableSortOrder"):"1",active:!0,recordId:""})}))},updateTableView:function(){"table"===this.model.getOutType()&&void 0!==this.views.table&&(this.views.table.model.setCurrentRecords(this.model.getRecords().byActive()),this.updateTableSortColumn(),this.updateTableSortOrder())},updateTableSortColumn:function(){"table"===this.model.getOutType()&&void 0!==this.views.table&&this.views.table.model.set("tableSortColumn",void 0!==this.model.get("tableSortColumn")?this.model.get("tableSortColumn"):"id")},updateTableSortOrder:function(){"table"===this.model.getOutType()&&void 0!==this.views.table&&this.views.table.model.set("tableSortOrder",void 0!==this.model.get("tableSortOrder")?this.model.get("tableSortOrder"):"1")},initMapView:function(){this.$("#map").length>0&&(this.views.map=this.views.map||new s({el:this.$("#map"),model:new a({labels:this.model.getLabels(),config:this.model.getMapConfig(),layerCollection:this.model.getLayers(),columnCollection:this.model.get("columnCollection"),active:!1,popupLayers:[],selectedLayerId:"",recordsUpdated:0})}))},updateMapView:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&(this.updateMapViewView(),this.updateOutMapType(),this.updateGeoQuery(),this.updateOutColorColumn(),this.updateOutPlotColumns(),this.views.map.model.setCurrentRecords(this.model.getRecords().byActive().hasLocation()),this.views.map.model.setRecordsUpdated(this.model.getRecordsUpdated()))},updateMapViewView:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&(this.views.map.model.setView(this.model.getActiveMapview()),this.views.map.model.invalidateSize())},updateOutMapType:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("outType",this.model.getOutMapType())},updateGeoQuery:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("geoQuery",this.model.get("geoQuery"))},updateOutColorColumn:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("outColorColumn",this.model.getOutColorColumn())},updateOutPlotColumns:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("outPlotColumns",this.model.getOutPlotColumns())},recordsPopup:function(){this.views.map.model.set({popupLayers:this.model.get("recordsPopup").length>0?t.map(this.model.get("recordsPopup"),function(e){return{id:e.getLayer().id,layer:e.getLayer().getMapLayerDirect(),color:e.getColor(),label:this.model.getLabels().record.title+" "+e.id,selected:e.isSelected(),mouseOver:e.id===this.model.get("recordMouseOverId")}},this):[]})},updateMouseOverRecord:function(){var e=this.model.get("recordMouseOverId");if(""!==e){var t=this.model.getRecords().get(e);t.isActive()&&this.views.map.model.set("mouseOverLayerId",t.getLayer().id)}else this.views.map.model.set("mouseOverLayerId","")},updateSelectedRecord:function(){var e=this.model.get("recordId");if(""!==e){var t=this.model.getRecords().get(e);t.isActive()&&("map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("selectedLayerId",t.getLayer().id),"table"===this.model.getOutType()&&void 0!==this.views.table&&this.views.table.model.set("recordId",e))}else"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("selectedLayerId",""),"table"===this.model.getOutType()&&void 0!==this.views.table&&this.views.table.model.set("recordId","")},toggleView:function(t){t.preventDefault(),this.model.set("dataToggled",!1),this.$el.trigger("setOutView",{out_view:e(t.currentTarget).attr("data-view")})},handleActive:function(){this.model.isActive()?this.$el.show():this.$el.hide()},queryReset:function(e){e.preventDefault(),this.$el.trigger("recordQuerySubmit",{query:{}})},toggleData:function(e){e.preventDefault(),this.model.set("dataToggled",!this.model.get("dataToggled")),this.model.get("dataToggled")?this.updateHeaderActive("data"):this.updateHeaderActive()},closeData:function(e){e.preventDefault(),this.model.set("dataToggled",!1),this.updateHeaderActive()},selectOnClick:function(e){e.preventDefault(),e.target.focus(),e.target.select(),setTimeout(function(){e.target.setSelectionRange(0,9999)},1)},downloadData:function(t){if(t.preventDefault(),this.canDownload()){var i=e(t.currentTarget).attr("data-format"),o=e(t.currentTarget).attr("data-table"),s=e(t.currentTarget).attr("data-active");if("csv"===i){var a,l="",d="";switch(o){case"records":l="true"===s?this.model.get("recordCollection").byActive().toCSV():this.model.get("recordCollection").toCSV(),d="true"===s?"records_filtered.csv":"records.csv";break;case"proxies":l=this.model.get("recordCollection").getProxies().toCSV(),d="proxies.csv";break;case"references":l=this.model.get("recordCollection").getReferences().toCSV(),d="references.csv"}window.__ga__&&c.loaded&&c("send","event","Download",o,"");var r=new Blob([l],{type:"text/csv;charset=utf-8;"});if(navigator&&navigator.msSaveBlob)navigator.msSaveBlob(r,d);else{var a=document.createElement("a");if(void 0!==a.download){var h=URL.createObjectURL(r);a.setAttribute("href",h),a.setAttribute("download",d),a.setAttribute("target","_blank"),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}}}}})});