define(["jquery","underscore","backbone","text!./table.html","text!./table_records.html","text!./table_header.html","text!./table_body.html"],function(t,e,i,o,l,s,d){return i.View.extend({events:{"click .expand-all":"expandAll","click .select-record":"selectRecord","click .sort-by":"sortRecords"},initialize:function(){this.handleActive(),this.initColumns(),this.listenTo(this.model,"change:active",this.handleActive),this.listenTo(this.model,"change:currentRecordCollection",this.update),this.listenTo(this.model,"change:expanded",this.render),this.listenTo(this.model,"change:recordId",this.updateActiveRecord),this.listenTo(this.model,"change:tableSortColumn",this.updateTableSortColumn),this.listenTo(this.model,"change:tableSortOrder",this.updateTableSortOrder),t(window).on("resize",e.debounce(e.bind(this.resize,this),100))},resize:function(){this.update()},render:function(){if(this.model.allExpanded()?this.$el.addClass("expanded"):this.$el.removeClass("expanded"),this.$el.html(e.template(o)({t:this.model.getLabels()})),"undefined"!=typeof this.model.getCurrentRecords()){var t=this.getSortedColumns();this.$(".record-table-scrolling-y table").html(e.template(l)({t:this.model.getLabels(),header:e.template(s)({t:this.model.getLabels(),columns:t,sortColumn:this.model.get("tableSortColumn"),sortOrder:this.model.get("tableSortOrder")}),body:this.getBodyHtml(this.model.getSortedRecords(),t)})),this.updateActiveRecord(),this.updateTable(),this.setTableHeight()}},update:function(){0===this.$(".record-table .record-table-scrolling-y tbody").length?this.render():(this.$(".record-table-scrolling-y table").css("tableLayout","auto"),this.$(".record-table-scrolling-y table tbody").html(this.getBodyHtml(this.model.getSortedRecords(),this.getSortedColumns())),this.updateActiveRecord(),this.updateTable(),this.setTableHeight())},initTable:function(){var t=this.$(".record-table-floating"),e=t.find("table"),i=this.$(".record-table-scrolling-y");e.empty(),i.find("table thead").clone().appendTo(e),this.setTableWidths(),i.css("top",t.outerHeight())},setTableHeight:function(){this.$(".record-table-scrolling-y").css("maxHeight",this.$(".record-table-scrolling-x").outerHeight()-this.$(".record-table-floating").outerHeight()-this.$(".record-table-scrolling-y").css("marginTop").replace("px",""))},setTableWidths:function(){var t=this.$(".record-table-floating"),e=t.find("table"),i=this.$(".record-table-scrolling-y"),o=i.find("table"),l=o.find("thead");l.show(),e.css("width",l.width()),o.css("width",l.width()),t.css("width",i.width()),o.css("tableLayout","auto"),e.css("tableLayout","auto"),this.copyWidths(l.find("th"),e.find("thead th")),this.copyWidths(l.find("th"),o.find("tbody tr:first-child td")),e.css("tableLayout","fixed"),o.css("tableLayout","fixed"),l.hide()},updateTable:function(){0===this.$(".record-table .record-table-floating thead").length?this.initTable():this.setTableWidths()},copyWidths:function(e,i){i.each(function(i){var o=t(e[i]).outerWidth();t(this).css({width:o,minWidth:o})})},getSortedColumns:function(){return this.model.allExpanded()?this.model.get("columnsSorted"):e.filter(e.clone(this.model.get("columnsSorted")),function(t){return t.get("isDefault")},this)},getBodyHtml:function(t,i){return e.template(d)({t:this.model.getLabels(),rows:e.map(t,function(t){return{record:t,columns:i}},this)})},updateActiveRecord:function(){var t=this.model.get("recordId");this.$(".tr-record").removeClass("selected"),""!==t&&this.$(".tr-record-"+t).addClass("selected")},initColumns:function(){var t=[];e.each(this.model.get("columnGroupCollection").models,function(i){e.each(this.model.get("columnCollection").byGroup(i.id).models,function(e){t.push(e)},this)},this),this.model.set("columnsSorted",t)},updateTableSortColumn:function(){this.$(".record-table thead th a.active").removeClass("active"),this.$(".record-table thead th a[data-column="+this.model.get("tableSortColumn")+"]").addClass("active"),this.updateTableSortOrder()},updateTableSortOrder:function(){"1"===this.model.get("tableSortOrder")?this.$(".record-table thead th a[data-column="+this.model.get("tableSortColumn")+"]").addClass("asc"):this.$(".record-table thead th a.asc").removeClass("asc"),this.update()},handleActive:function(){this.model.isActive()?(this.$el.show(),this.render()):this.$el.hide()},expandAll:function(){this.model.allExpanded()?this.model.setExpanded(!1):this.model.setExpanded(!0)},selectRecord:function(e){e.preventDefault(),this.$el.trigger("recordSelect",{id:t(e.currentTarget).attr("data-recordid")})},sortRecords:function(e){e.preventDefault();var i=t(e.currentTarget).attr("data-column");this.$el.trigger("sortRecords",{column:i,order:i===this.model.get("tableSortColumn")?parseInt(this.model.get("tableSortOrder"))*-1:1})}})});