define(["jquery","underscore","backbone","bootstrap","jquery.waypoints","text!./record.html","text!./recordMenu.html","text!./recordColumnText.html","text!./recordColumnProxies.html","text!./recordColumnReferences.html"],function(t,e,i,o,n,r,l,s,a,c){return i.View.extend({events:{"click .close-record":"closeRecord","click .nav-link":"handleNavLink","click .record-top-menu-link":"handleInViewLink"},initialize:function(){this.render(),this.listenTo(this.model,"change:active",this.handleActive),this.listenTo(this.model,"change:record",this.update),this.scroll_offset_group=40,this.waypoints_offset_group=200,this._scrolling=!1,t(window).on("resize",e.debounce(e.bind(this.resize,this),200))},render:function(){return this},resize:function(){void 0!==this.model&&this.model.isActive()&&this.refreshWaypoints()},renderTopMenu:function(){return e.template(l)({groups:e.filter(this.model.get("columnGroupCollection").models,function(t){return"id"!==t.id})})},update:function(){var t=this.model.get("columnCollection").byAttribute("single");this.$el.html(e.template(r)({t:this.model.getLabels(),recordid:this.model.get("record").id,recordMenu:this.renderTopMenu(),columnGroups:e.filter(e.map(this.model.get("columnGroupCollection").models,function(i){var o="group-"+i.id,n=t.byGroup(i.id).models;return 0!==n.length&&"id"!==i.id&&{title:i.get("title"),hint:i.get("hint"),id:i.id,classes:o,groupColumns:e.filter(e.map(n,function(t){return this.getColumnHtml(t,i.id)},this),function(t){return!1!==t})}},this),function(t){return!1!==t})})),this.initTooltips(),this.initWaypoints()},initWaypoints:function(){var e=this;this.$(".record-top-menu-link").removeClass("active"),this.$(".group").waypoint({handler:function(i){if(!e._scrolling&&e.model.isActive()){var o=t(this.element).data("index");if("down"===i)e.groupActive(o);else{var n=t(o>0?'.group[data-index="'+(parseInt(o)-1).toString()+'"]':this.element);0!==n.length&&e.groupActive(n.data("index"))}}},context:this.$(".record-main"),offset:this.waypoints_offset_group,continuous:!0})},groupActive:function(t){this.$(".record-top-menu-link").removeClass("active"),this.$('.record-top-menu-link[data-index="'+t+'"]').addClass("active")},refreshWaypoints:function(){window.Waypoint.refreshAll()},initTooltips:function(){this.$('[data-toggle="tooltip"]').tooltip()},getColumnHtml:function(t){var i=this.model.get("record");switch(t.get("type")){case"index":if("references"===t.id)return e.template(c)({t:this.model.getLabels(),title:t.get("title"),references:i.getReferences(),id:t.id,tooltip:t.get("description"),tooltip_more:t.hasMoreDescription(),hint:t.get("hint")});if("proxies"===t.id)return e.template(a)({t:this.model.getLabels(),title:t.get("title"),proxies:i.getProxies(),id:t.id,tooltip:t.get("description"),tooltip_more:t.hasMoreDescription(),hint:t.get("hint")});break;case"date":if(1===t.get("combo")){if(1===t.get("filterable")){var o=this.model.get("columnCollection").get(t.get("comboColumnId")),n="";return n="min"===t.get("comboType")?i.getColumnValue(o.get("column"),!0)+" - "+i.getColumnValue(t.get("column"),!0):i.getColumnValue(t.get("column"),!0)+" - "+i.getColumnValue(o.get("column"),!0),e.template(s)({t:this.model.getLabels(),title:t.get("comboTitle"),value:n,id:t.id,tooltip:t.get("comboDescription"),tooltip_more:t.hasMoreDescription(),hint:t.get("hint")})}return""}break;case"quantitative":case"spatial":case"categorical":case"ordinal":case"text":return e.template(s)({t:this.model.getLabels(),title:t.get("title"),value:i.getColumnValue(t.get("column"),!0),id:t.id,tooltip:t.get("description"),tooltip_more:t.hasMoreDescription(),hint:t.get("hint")});default:return!1}},handleActive:function(){this.model.isActive()?this.$el.show():this.$el.hide()},closeRecord:function(t){t.preventDefault(),this.$el.trigger("recordClose")},handleNavLink:function(e){e.preventDefault(),e.stopPropagation(),this.$el.trigger("navLink",{id:t(e.currentTarget).attr("data-id"),anchor:t(e.currentTarget).attr("data-page-anchor"),route:"page",type:"page"})},handleInViewLink:function(e){e.preventDefault();var i=this.$(".record-main").scrollTop()+this.$(".group-"+t(e.target).attr("data-group")).offset().top-this.$(".record-main").offset().top-this.scroll_offset_group;this._scrolling=!0;var o=this;this.$(".record-main").animate({scrollTop:i},300,function(){o._scrolling=!1,o.groupActive(t(e.target).attr("data-index"))})}})});