define(["jquery","underscore","backbone","./RecordModel"],function(t,e,n,o){var i=n.Collection.extend({model:o,initialize:function(t,e){this.options=e||{},this.selectedId=null,this.query={}},byActive:function(t){return t="undefined"==typeof t||t,new i(this.filter(function(e){return e.isActive()===t}),this.options)},updateActive:function(t){e.each(e.clone(this.models).reverse(),function(e){e.setActive(e.pass(t))})},highlightReset:function(){e.each(this.byHighlight().models,function(t){t.setHighlight(!1)}),this.moveRecordToFront()},highlightRecord:function(t){this.highlightReset();var e=this.get(t);return"undefined"!=typeof e&&e.setHighlight(!0),e},updateRecords:function(t){this.query=t.query;var n=this;e.each(e.clone(this.models).reverse(),function(e){e.setActive(e.pass(t.query)),t.selectedId!==n.selectedId&&(""===t.selectedId?e.setSelected(!1):e.setSelected(e.id===t.selectedId,!0)),e.isActive()&&e.setColor(t.colorColumn.getColor(e.getColumnValue(t.colorColumn.get("column"))))}),this.selectedId=""!==t.selectedId?t.selectedId:null},moveRecordToFront:function(t){if(t="undefined"!=typeof t?t:this.selectedId){var e=this.get(t);e&&e.bringToFront()}},byHighlight:function(){return new i(this.filter(function(t){return t.isHighlight()}),this.options)},byXY:function(t,e){return new i(this.filter(function(n){return n.passXY(t,e)}),this.options)},byQuery:function(t){return new i(this.filter(function(e){return e.pass(t)}),this.options)},byBounds:function(t){var e=this.options.columns.get("lat"),n=this.options.columns.get("lng"),o={};return o[e.getQueryColumnByType("min")]=t.south,o[e.getQueryColumnByType("max")]=t.north,o[n.getQueryColumnByType("min")]=t.west,o[n.getQueryColumnByType("max")]=t.east,new i(this.filter(function(t){return t.pass(o)}),this.options)},hasLocation:function(){return new i(this.reject(function(t){return null===t.get("latitude")}),this.options)},getValuesForColumn:function(t){var n=[];return e.each(this.models,function(o){null!==o.get(t)&&(isNumber(o.get(t))?n.push(o.get(t)):n=e.union(n,e.map(o.get(t).split(","),function(t){return t.trim()})))}),n.sort(function(t,e){return"Unknown"===t?1:"Unknown"===e?-1:t<e?-1:t>e?1:0})},setColumns:function(t){this.options.columns=t},getColumns:function(){return this.options.columns},setProxies:function(t){this.options.proxies=t},getProxies:function(){return this.options.proxies},setReferences:function(t){this.options.references=t},getReferences:function(){return this.options.references},sortBy:function(t,e){var n=this.clone();return n.comparator=function(n,o){var i=n.get(t),s=o.get(t);return null===i||""===i||null===s||""===s?null!==i&&""!==i||null===s||""===s?null===i||""===i||null!==s&&""!==s?(i>s?1:s>i?-1:0)*e:-1:1:(i>s?1:-1)*e},n.sort(),n.models},toCSV:function(){var t=this.options.columns,n=",",o="\n",i="",s=e.map(t.models,function(t){return t.getQueryColumn()});return i+=s.join(n),i+=o,e.each(this.models,function(t){e.each(s,function(e,o){o>0&&(i+=n),i+='"',i+=null!==t.getColumnValue(e)?t.getColumnValue(e).toString().replace(/"/g,'""'):"",i+='"'}),i+=o}),i}});return i});