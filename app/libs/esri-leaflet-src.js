/*! esri-leaflet - v1.0.0 - 2015-07-10
*   Copyright (c) 2015 Environmental Systems Research Institute, Inc.
*   Apache License*/

!function(e){"function"==typeof define&&define.amd?define(["leaflet"],function(t){return e(t)}):"object"==typeof module&&"object"==typeof module.exports&&(module.exports=e(require("leaflet"))),"undefined"!=typeof window&&window.L&&e(window.L)}(function(e){var t={VERSION:"1.0.0",Layers:{},Services:{},Controls:{},Tasks:{},Util:{},Support:{CORS:!!(window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest),pointerEvents:""===document.documentElement.style.pointerEvents}};return"undefined"!=typeof window&&window.L&&(window.L.esri=t),function(t){function i(e){var t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}function s(e,t){for(var i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}function r(e){return s(e[0],e[e.length-1])||e.push(e[0]),e}function o(e){var t,i=0,s=0,r=e.length,o=e[s];for(s;s<r-1;s++)t=e[s+1],i+=(t[0]-o[0])*(t[1]+o[1]),o=t;return i>=0}function n(e,t,i,s){var r=(s[0]-i[0])*(e[1]-i[1])-(s[1]-i[1])*(e[0]-i[0]),o=(t[0]-e[0])*(e[1]-i[1])-(t[1]-e[1])*(e[0]-i[0]),n=(s[1]-i[1])*(t[0]-e[0])-(s[0]-i[0])*(t[1]-e[1]);if(0!==n){var a=r/n,u=o/n;if(0<=a&&a<=1&&0<=u&&u<=1)return!0}return!1}function a(e,t){for(var i=0;i<e.length-1;i++)for(var s=0;s<t.length-1;s++)if(n(e[i],e[i+1],t[s],t[s+1]))return!0;return!1}function u(e,t){for(var i=!1,s=-1,r=e.length,o=r-1;++s<r;o=s)(e[s][1]<=t[1]&&t[1]<e[o][1]||e[o][1]<=t[1]&&t[1]<e[s][1])&&t[0]<(e[o][0]-e[s][0])*(t[1]-e[s][1])/(e[o][1]-e[s][1])+e[s][0]&&(i=!i);return i}function l(e,t){var i=a(e,t),s=u(e,t[0]);return!(i||!s)}function h(e){for(var t,i,s,n=[],u=[],h=0;h<e.length;h++){var c=r(e[h].slice(0));if(!(c.length<4))if(o(c)){var p=[c];n.push(p)}else u.push(c)}for(var d=[];u.length;){s=u.pop();var m=!1;for(t=n.length-1;t>=0;t--)if(i=n[t][0],l(i,s)){n[t].push(s),m=!0;break}m||d.push(s)}for(;d.length;){s=d.pop();var f=!1;for(t=n.length-1;t>=0;t--)if(i=n[t][0],a(i,s)){n[t].push(s),f=!0;break}f||n.push([s.reverse()])}return 1===n.length?{type:"Polygon",coordinates:n[0]}:{type:"MultiPolygon",coordinates:n}}function c(e){var t=[],i=e.slice(0),s=r(i.shift().slice(0));if(s.length>=4){o(s)||s.reverse(),t.push(s);for(var n=0;n<i.length;n++){var a=r(i[n].slice(0));a.length>=4&&(o(a)&&a.reverse(),t.push(a))}}return t}function p(e){for(var t=[],i=0;i<e.length;i++)for(var s=c(e[i]),r=s.length-1;r>=0;r--){var o=s[r].slice(0);t.push(o)}return t}var d=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)};t.Util.extentToBounds=function(t){var i=new e.LatLng(t.ymin,t.xmin),s=new e.LatLng(t.ymax,t.xmax);return new e.LatLngBounds(i,s)},t.Util.boundsToExtent=function(t){return t=e.latLngBounds(t),{xmin:t.getSouthWest().lng,ymin:t.getSouthWest().lat,xmax:t.getNorthEast().lng,ymax:t.getNorthEast().lat,spatialReference:{wkid:4326}}},t.Util.arcgisToGeojson=function(e,s){var r={};return"number"==typeof e.x&&"number"==typeof e.y&&(r.type="Point",r.coordinates=[e.x,e.y]),e.points&&(r.type="MultiPoint",r.coordinates=e.points.slice(0)),e.paths&&(1===e.paths.length?(r.type="LineString",r.coordinates=e.paths[0].slice(0)):(r.type="MultiLineString",r.coordinates=e.paths.slice(0))),e.rings&&(r=h(e.rings.slice(0))),(e.geometry||e.attributes)&&(r.type="Feature",r.geometry=e.geometry?t.Util.arcgisToGeojson(e.geometry):null,r.properties=e.attributes?i(e.attributes):null,e.attributes&&(r.id=e.attributes[s]||e.attributes.OBJECTID||e.attributes.FID)),r},t.Util.geojsonToArcGIS=function(e,s){s=s||"OBJECTID";var r,o={wkid:4326},n={};switch(e.type){case"Point":n.x=e.coordinates[0],n.y=e.coordinates[1],n.spatialReference=o;break;case"MultiPoint":n.points=e.coordinates.slice(0),n.spatialReference=o;break;case"LineString":n.paths=[e.coordinates.slice(0)],n.spatialReference=o;break;case"MultiLineString":n.paths=e.coordinates.slice(0),n.spatialReference=o;break;case"Polygon":n.rings=c(e.coordinates.slice(0)),n.spatialReference=o;break;case"MultiPolygon":n.rings=p(e.coordinates.slice(0)),n.spatialReference=o;break;case"Feature":e.geometry&&(n.geometry=t.Util.geojsonToArcGIS(e.geometry,s)),n.attributes=e.properties?i(e.properties):{},e.id&&(n.attributes[s]=e.id);break;case"FeatureCollection":for(n=[],r=0;r<e.features.length;r++)n.push(t.Util.geojsonToArcGIS(e.features[r],s));break;case"GeometryCollection":for(n=[],r=0;r<e.geometries.length;r++)n.push(t.Util.geojsonToArcGIS(e.geometries[r],s))}return n},t.Util.responseToFeatureCollection=function(e,i){var s;if(i)s=i;else if(e.objectIdFieldName)s=e.objectIdFieldName;else if(e.fields){for(var r=0;r<=e.fields.length-1;r++)if("esriFieldTypeOID"===e.fields[r].type){s=e.fields[r].name;break}}else s="OBJECTID";var o={type:"FeatureCollection",features:[]},n=e.features||e.results;if(n.length)for(var a=n.length-1;a>=0;a--)o.features.push(t.Util.arcgisToGeojson(n[a],s));return o},t.Util.cleanUrl=function(e){return e=e.replace(/^\s+|\s+$|\A\s+|\s+\z/g,""),"/"!==e[e.length-1]&&(e+="/"),e},t.Util.isArcgisOnline=function(e){return/\.arcgis\.com.*?FeatureServer/g.test(e)},t.Util.geojsonTypeToArcGIS=function(e){var t;switch(e){case"Point":t="esriGeometryPoint";break;case"MultiPoint":t="esriGeometryMultipoint";break;case"LineString":case"MultiLineString":t="esriGeometryPolyline";break;case"Polygon":case"MultiPolygon":t="esriGeometryPolygon"}return t},t.Util.requestAnimationFrame=e.Util.bind(d,window),t.Util.warn=function(e){console&&console.warn&&console.warn(e)}}(t),function(t){function i(e){var t="";e.f=e.f||"json";for(var i in e)if(e.hasOwnProperty(i)){var s,r=e[i],o=Object.prototype.toString.call(r);t.length&&(t+="&"),s="[object Array]"===o?"[object Object]"===Object.prototype.toString.call(r[0])?JSON.stringify(r):r.join(","):"[object Object]"===o?JSON.stringify(r):"[object Date]"===o?r.valueOf():r,t+=encodeURIComponent(i)+"="+encodeURIComponent(s)}return t}function s(t,i){var s=new XMLHttpRequest;return s.onerror=function(r){s.onreadystatechange=e.Util.falseFn,t.call(i,{error:{code:500,message:"XMLHttpRequest error"}},null)},s.onreadystatechange=function(){var r,o;if(4===s.readyState){try{r=JSON.parse(s.responseText)}catch(e){r=null,o={code:500,message:"Could not parse response as JSON. This could also be caused by a CORS or XMLHttpRequest error."}}!o&&r.error&&(o=r.error,r=null),s.onerror=e.Util.falseFn,t.call(i,o,r)}},s}var r=0;window._EsriLeafletCallbacks={},t.Request={request:function(r,o,n,a){var u=i(o),l=s(n,a),h=(r+"?"+u).length;if(h<=2e3&&e.esri.Support.CORS)l.open("GET",r+"?"+u),l.send(null);else{if(!(h>2e3&&e.esri.Support.CORS))return h<=2e3&&!e.esri.Support.CORS?e.esri.Request.get.JSONP(r,o,n,a):void t.Util.warn("a request to "+r+" was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy http://esri.github.io/esri-leaflet/api-reference/request.html");l.open("POST",r),l.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),l.send(u)}return l},post:{XMLHTTP:function(e,t,r,o){var n=s(r,o);return n.open("POST",e),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(i(t)),n}},get:{CORS:function(e,t,r,o){var n=s(r,o);return n.open("GET",e+"?"+i(t),!0),n.send(null),n},JSONP:function(t,s,o,n){var a="c"+r;s.callback="window._EsriLeafletCallbacks."+a;var u=e.DomUtil.create("script",null,document.body);return u.type="text/javascript",u.src=t+"?"+i(s),u.id=a,window._EsriLeafletCallbacks[a]=function(e){if(!0!==window._EsriLeafletCallbacks[a]){var t,i=Object.prototype.toString.call(e);"[object Object]"!==i&&"[object Array]"!==i&&(t={error:{code:500,message:"Expected array or object as JSONP response"}},e=null),!t&&e.error&&(t=e,e=null),o.call(n,t,e),window._EsriLeafletCallbacks[a]=!0}},r++,{id:a,url:u.src,abort:function(){window._EsriLeafletCallbacks._callback[a]({code:0,message:"Request aborted."})}}}}},t.get=t.Support.CORS?t.Request.get.CORS:t.Request.get.JSONP,t.post=t.Request.post.XMLHTTP,t.request=t.Request.request}(t),t.Services.Service=e.Class.extend({includes:e.Mixin.Events,options:{proxy:!1,useCors:t.Support.CORS},initialize:function(i){i=i||{},this._requestQueue=[],this._authenticating=!1,e.Util.setOptions(this,i),this.options.url=t.Util.cleanUrl(this.options.url)},get:function(e,t,i,s){return this._request("get",e,t,i,s)},post:function(e,t,i,s){return this._request("post",e,t,i,s)},request:function(e,t,i,s){return this._request("request",e,t,i,s)},metadata:function(e,t){return this._request("get","",{},e,t)},authenticate:function(e){return this._authenticating=!1,this.options.token=e,this._runQueue(),this},_request:function(e,i,s,r,o){this.fire("requeststart",{url:this.options.url+i,params:s,method:e});var n=this._createServiceCallback(e,i,s,r,o);if(this.options.token&&(s.token=this.options.token),this._authenticating)return void this._requestQueue.push([e,i,s,r,o]);var a=this.options.proxy?this.options.proxy+"?"+this.options.url+i:this.options.url+i;return"get"!==e&&"request"!==e||this.options.useCors?t[e](a,s,n):t.Request.get.JSONP(a,s,n)},_createServiceCallback:function(t,i,s,r,o){return e.Util.bind(function(n,a){!n||499!==n.code&&498!==n.code||(this._authenticating=!0,this._requestQueue.push([t,i,s,r,o]),this.fire("authenticationrequired",{authenticate:e.Util.bind(this.authenticate,this)}),n.authenticate=e.Util.bind(this.authenticate,this)),r.call(o,n,a),n?this.fire("requesterror",{url:this.options.url+i,params:s,message:n.message,code:n.code,method:t}):this.fire("requestsuccess",{url:this.options.url+i,params:s,response:a,method:t}),this.fire("requestend",{url:this.options.url+i,params:s,method:t})},this)},_runQueue:function(){for(var e=this._requestQueue.length-1;e>=0;e--){var t=this._requestQueue[e];this[t.shift()].apply(this,t)}this._requestQueue=[]}}),t.Services.service=function(e){return new t.Services.Service(e)},t.Services.FeatureLayerService=t.Services.Service.extend({options:{idAttribute:"OBJECTID"},query:function(){return new t.Tasks.Query(this)},addFeature:function(e,i,s){return delete e.id,e=t.Util.geojsonToArcGIS(e),this.post("addFeatures",{features:[e]},function(e,t){var r=t&&t.addResults?t.addResults[0]:void 0;i&&i.call(s,e||t.addResults[0].error,r)},s)},updateFeature:function(e,i,s){return e=t.Util.geojsonToArcGIS(e,this.options.idAttribute),this.post("updateFeatures",{features:[e]},function(e,t){var r=t&&t.updateResults?t.updateResults[0]:void 0;i&&i.call(s,e||t.updateResults[0].error,r)},s)},deleteFeature:function(e,t,i){return this.post("deleteFeatures",{objectIds:e},function(e,s){var r=s&&s.deleteResults?s.deleteResults[0]:void 0;t&&t.call(i,e||s.deleteResults[0].error,r)},i)},deleteFeatures:function(e,t,i){return this.post("deleteFeatures",{objectIds:e},function(e,s){var r=s&&s.deleteResults?s.deleteResults:void 0;t&&t.call(i,e||s.deleteResults[0].error,r)},i)}}),t.Services.featureLayerService=function(e){return new t.Services.FeatureLayerService(e)},t.Services.MapService=t.Services.Service.extend({identify:function(){return new t.Tasks.identifyFeatures(this)},find:function(){return new t.Tasks.Find(this)},query:function(){return new t.Tasks.Query(this)}}),t.Services.mapService=function(e){return new t.Services.MapService(e)},t.Services.ImageService=t.Services.Service.extend({query:function(){return new t.Tasks.Query(this)},identify:function(){return new t.Tasks.IdentifyImage(this)}}),t.Services.imageService=function(e){return new t.Services.ImageService(e)},t.Tasks.Task=e.Class.extend({options:{proxy:!1,useCors:t.Support.CORS},generateSetter:function(t,i){return e.Util.bind(function(e){return this.params[t]=e,this},i)},initialize:function(t){if(t.request&&t.options?(this._service=t,e.Util.setOptions(this,t.options)):(e.Util.setOptions(this,t),this.options.url=e.esri.Util.cleanUrl(t.url)),this.params=e.Util.extend({},this.params||{}),this.setters)for(var i in this.setters){var s=this.setters[i];this[i]=this.generateSetter(s,this)}},token:function(e){return this._service?this._service.authenticate(e):this.params.token=e,this},request:function(e,t){return this._service?this._service.request(this.path,this.params,e,t):this._request("request",this.path,this.params,e,t)},_request:function(e,i,s,r,o){var n=this.options.proxy?this.options.proxy+"?"+this.options.url+i:this.options.url+i;return"get"!==e&&"request"!==e||this.options.useCors?t[e](n,s,r,o):t.Request.get.JSONP(n,s,r,o)}}),t.Tasks.Query=t.Tasks.Task.extend({setters:{offset:"offset",limit:"limit",fields:"outFields",precision:"geometryPrecision",featureIds:"objectIds",returnGeometry:"returnGeometry",token:"token"},path:"query",params:{returnGeometry:!0,where:"1=1",outSr:4326,outFields:"*"},within:function(e){return this._setGeometry(e),this.params.spatialRel="esriSpatialRelContains",this},intersects:function(e){return this._setGeometry(e),this.params.spatialRel="esriSpatialRelIntersects",this},contains:function(e){return this._setGeometry(e),this.params.spatialRel="esriSpatialRelWithin",this},overlaps:function(e){return this._setGeometry(e),this.params.spatialRel="esriSpatialRelOverlaps",this},nearby:function(t,i){return t=e.latLng(t),this.params.geometry=[t.lng,t.lat],this.params.geometryType="esriGeometryPoint",this.params.spatialRel="esriSpatialRelIntersects",this.params.units="esriSRUnit_Meter",this.params.distance=i,this.params.inSr=4326,this},where:function(e){return this.params.where=e,this},between:function(e,t){return this.params.time=[e.valueOf(),t.valueOf()],this},simplify:function(e,t){var i=Math.abs(e.getBounds().getWest()-e.getBounds().getEast());return this.params.maxAllowableOffset=i/e.getSize().y*t,this},orderBy:function(e,t){return t=t||"ASC",this.params.orderByFields=this.params.orderByFields?this.params.orderByFields+",":"",this.params.orderByFields+=[e,t].join(" "),this},run:function(e,i){return this._cleanParams(),t.Util.isArcgisOnline(this.options.url)?(this.params.f="geojson",this.request(function(t,s){this._trapSQLerrors(t),e.call(i,t,s,s)},this)):this.request(function(s,r){this._trapSQLerrors(s),e.call(i,s,r&&t.Util.responseToFeatureCollection(r),r)},this)},count:function(e,t){return this._cleanParams(),this.params.returnCountOnly=!0,this.request(function(t,i){e.call(this,t,i&&i.count,i)},t)},ids:function(e,t){return this._cleanParams(),this.params.returnIdsOnly=!0,this.request(function(t,i){e.call(this,t,i&&i.objectIds,i)},t)},bounds:function(e,i){return this._cleanParams(),this.params.returnExtentOnly=!0,this.request(function(s,r){e.call(i,s,r&&r.extent&&t.Util.extentToBounds(r.extent),r)},i)},pixelSize:function(t){return t=e.point(t),this.params.pixelSize=[t.x,t.y],this},layer:function(e){return this.path=e+"/query",this},_trapSQLerrors:function(e){e&&"400"===e.code&&t.Util.warn("one common syntax error in query requests is encasing string values in double quotes instead of single quotes")},_cleanParams:function(){delete this.params.returnIdsOnly,delete this.params.returnExtentOnly,delete this.params.returnCountOnly},_setGeometry:function(i){return this.params.inSr=4326,i instanceof e.LatLngBounds?(this.params.geometry=t.Util.boundsToExtent(i),void(this.params.geometryType="esriGeometryEnvelope")):(i.getLatLng&&(i=i.getLatLng()),i instanceof e.LatLng&&(i={type:"Point",coordinates:[i.lng,i.lat]}),i instanceof e.GeoJSON&&(i=i.getLayers()[0].feature.geometry,this.params.geometry=t.Util.geojsonToArcGIS(i),this.params.geometryType=t.Util.geojsonTypeToArcGIS(i.type)),i.toGeoJSON&&(i=i.toGeoJSON()),"Feature"===i.type&&(i=i.geometry),"Point"===i.type||"LineString"===i.type||"Polygon"===i.type?(this.params.geometry=t.Util.geojsonToArcGIS(i),void(this.params.geometryType=t.Util.geojsonTypeToArcGIS(i.type))):void t.Util.warn("invalid geometry passed to spatial query. Should be an L.LatLng, L.LatLngBounds or L.Marker or a GeoJSON Point Line or Polygon object"))}}),t.Tasks.query=function(e){return new t.Tasks.Query(e)},t.Tasks.Find=t.Tasks.Task.extend({setters:{contains:"contains",text:"searchText",fields:"searchFields",spatialReference:"sr",sr:"sr",layers:"layers",returnGeometry:"returnGeometry",maxAllowableOffset:"maxAllowableOffset",precision:"geometryPrecision",dynamicLayers:"dynamicLayers",returnZ:"returnZ",returnM:"returnM",gdbVersion:"gdbVersion",token:"token"},path:"find",params:{sr:4326,contains:!0,returnGeometry:!0,returnZ:!0,returnM:!1},layerDefs:function(e,t){return this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+";":"",this.params.layerDefs+=[e,t].join(":"),this},simplify:function(e,t){var i=Math.abs(e.getBounds().getWest()-e.getBounds().getEast());return this.params.maxAllowableOffset=i/e.getSize().y*t,this},run:function(e,i){return this.request(function(s,r){e.call(i,s,r&&t.Util.responseToFeatureCollection(r),r)},i)}}),t.Tasks.find=function(e){return new t.Tasks.Find(e)},t.Tasks.Identify=t.Tasks.Task.extend({path:"identify",between:function(e,t){return this.params.time=[e.valueOf(),t.valueOf()],this}}),t.Tasks.IdentifyImage=t.Tasks.Identify.extend({setters:{setMosaicRule:"mosaicRule",setRenderingRule:"renderingRule",setPixelSize:"pixelSize",returnCatalogItems:"returnCatalogItems",returnGeometry:"returnGeometry"},params:{returnGeometry:!1},at:function(t){return t=e.latLng(t),this.params.geometry=JSON.stringify({x:t.lng,y:t.lat,spatialReference:{wkid:4326}}),this.params.geometryType="esriGeometryPoint",this},getMosaicRule:function(){return this.params.mosaicRule},getRenderingRule:function(){return this.params.renderingRule},getPixelSize:function(){return this.params.pixelSize},run:function(e,t){return this.request(function(i,s){e.call(t,i,s&&this._responseToGeoJSON(s),s)},this)},_responseToGeoJSON:function(e){var i=e.location,s=e.catalogItems,r=e.catalogItemVisibilities,o={pixel:{type:"Feature",geometry:{type:"Point",coordinates:[i.x,i.y]},crs:{type:"EPSG",properties:{code:i.spatialReference.wkid}},properties:{OBJECTID:e.objectId,name:e.name,value:e.value},id:e.objectId}};if(e.properties&&e.properties.Values&&(o.pixel.properties.values=e.properties.Values),s&&s.features&&(o.catalogItems=t.Util.responseToFeatureCollection(s),r&&r.length===o.catalogItems.features.length))for(var n=r.length-1;n>=0;n--)o.catalogItems.features[n].properties.catalogItemVisibility=r[n];return o}}),t.Tasks.identifyImage=function(e){return new t.Tasks.IdentifyImage(e)},t.Tasks.IdentifyFeatures=t.Tasks.Identify.extend({setters:{layers:"layers",precision:"geometryPrecision",tolerance:"tolerance",returnGeometry:"returnGeometry"},params:{sr:4326,layers:"all",tolerance:3,returnGeometry:!0},on:function(e){var i=t.Util.boundsToExtent(e.getBounds()),s=e.getSize();return this.params.imageDisplay=[s.x,s.y,96],this.params.mapExtent=[i.xmin,i.ymin,i.xmax,i.ymax],this},at:function(t){return t=e.latLng(t),this.params.geometry=[t.lng,t.lat],this.params.geometryType="esriGeometryPoint",this},layerDef:function(e,t){return this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+";":"",this.params.layerDefs+=[e,t].join(":"),this},simplify:function(e,t){var i=Math.abs(e.getBounds().getWest()-e.getBounds().getEast());return this.params.maxAllowableOffset=i/e.getSize().y*(1-t),this},run:function(e,i){return this.request(function(s,r){if(s)return void e.call(i,s,void 0,r);var o=t.Util.responseToFeatureCollection(r);r.results=r.results.reverse();for(var n=0;n<o.features.length;n++){o.features[n].layerId=r.results[n].layerId}e.call(i,void 0,o,r)})}}),t.Tasks.identifyFeatures=function(e){return new t.Tasks.IdentifyFeatures(e)},function(t){var i="https:"!==window.location.protocol?"http:":"https:";t.Layers.BasemapLayer=e.TileLayer.extend({statics:{TILES:{Streets:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"https://static.arcgis.com/attribution/World_Street_Map",options:{hideLogo:!1,logoPosition:"bottomright",minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"Esri"}},Topographic:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"https://static.arcgis.com/attribution/World_Topo_Map",options:{hideLogo:!1,logoPosition:"bottomright",minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"Esri"}},Oceans:{urlTemplate:i+"//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}",attributionUrl:"https://static.arcgis.com/attribution/Ocean_Basemap",options:{hideLogo:!1,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"Esri"}},OceansLabels:{urlTemplate:i+"//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!0,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"]}},NationalGeographic:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!1,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"Esri"}},DarkGray:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!1,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"Esri, DeLorme, HERE"}},DarkGrayLabels:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!0,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"]}},Gray:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!1,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"Esri, NAVTEQ, DeLorme"}},GrayLabels:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!0,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"]}},Imagery:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!1,logoPosition:"bottomright",minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"Esri, DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community"}},ImageryLabels:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!0,logoPosition:"bottomright",minZoom:1,maxZoom:19,subdomains:["server","services"]}},ImageryTransportation:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!0,logoPosition:"bottomright",minZoom:1,maxZoom:19,subdomains:["server","services"]}},ShadedRelief:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!1,logoPosition:"bottomright",minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:"Esri, NAVTEQ, DeLorme"}},ShadedReliefLabels:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places_Alternate/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!0,logoPosition:"bottomright",minZoom:1,maxZoom:12,subdomains:["server","services"]}},Terrain:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!1,logoPosition:"bottomright",minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:"Esri, USGS, NOAA"}},TerrainLabels:{urlTemplate:i+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:!0,logoPosition:"bottomright",minZoom:1,maxZoom:13,subdomains:["server","services"]}}}},initialize:function(i,s){var r;if("object"==typeof i&&i.urlTemplate&&i.options)r=i;else{if("string"!=typeof i||!t.BasemapLayer.TILES[i])throw new Error('L.esri.BasemapLayer: Invalid parameter. Use one of "Streets", "Topographic", "Oceans", "OceansLabels", "NationalGeographic", "Gray", "GrayLabels", "DarkGray", "DarkGrayLabels", "Imagery", "ImageryLabels", "ImageryTransportation", "ShadedRelief", "ShadedReliefLabels", "Terrain" or "TerrainLabels"');r=t.BasemapLayer.TILES[i]}var o=e.Util.extend(r.options,s);e.TileLayer.prototype.initialize.call(this,r.urlTemplate,e.Util.setOptions(this,o)),r.attributionUrl&&this._getAttributionData(r.attributionUrl),this._logo=new t.Controls.Logo({position:this.options.logoPosition})},onAdd:function(t){this.options.hideLogo||t._hasEsriLogo||(this._logo.addTo(t),t._hasEsriLogo=!0),e.TileLayer.prototype.onAdd.call(this,t),t.on("moveend",this._updateMapAttribution,this)},onRemove:function(t){this._logo&&this._logo._container&&(t.removeControl(this._logo),t._hasEsriLogo=!1),e.TileLayer.prototype.onRemove.call(this,t),t.off("moveend",this._updateMapAttribution,this)},getAttribution:function(){return'<span class="esri-attributions" style="line-height:14px; vertical-align: -3px; text-overflow:ellipsis; white-space:nowrap; overflow:hidden; display:inline-block;">'+this.options.attribution+"</span>"},_getAttributionData:function(t){e.esri.Request.get.JSONP(t,{},e.Util.bind(function(t,i){this._attributions=[];for(var s=0;s<i.contributors.length;s++)for(var r=i.contributors[s],o=0;o<r.coverageAreas.length;o++){var n=r.coverageAreas[o],a=new e.LatLng(n.bbox[0],n.bbox[1]),u=new e.LatLng(n.bbox[2],n.bbox[3]);this._attributions.push({attribution:r.attribution,score:n.score,bounds:new e.LatLngBounds(a,u),minZoom:n.zoomMin,maxZoom:n.zoomMax})}this._attributions.sort(function(e,t){return t.score-e.score}),this._updateMapAttribution()},this))},_updateMapAttribution:function(){if(this._map&&this._map.attributionControl&&this._attributions){for(var e="",t=this._map.getBounds(),i=this._map.getZoom(),s=0;s<this._attributions.length;s++){var r=this._attributions[s],o=r.attribution;!e.match(o)&&t.intersects(r.bounds)&&i>=r.minZoom&&i<=r.maxZoom&&(e+=", "+o)}e=e.substr(2);var n=this._map.attributionControl._container.querySelector(".esri-attributions");n.innerHTML=e,n.style.maxWidth=.65*this._map.getSize().x+"px",this.fire("attributionupdated",{attribution:e})}}}),t.BasemapLayer=t.Layers.BasemapLayer,t.Layers.basemapLayer=function(e,i){return new t.Layers.BasemapLayer(e,i)},t.basemapLayer=function(e,i){return new t.Layers.BasemapLayer(e,i)}}(t),t.Layers.RasterLayer=e.Class.extend({includes:e.Mixin.Events,options:{opacity:1,position:"front",f:"image"},onAdd:function(t){if(this._map=t,this._update=e.Util.limitExecByInterval(this._update,this.options.updateInterval,this),t.options.crs&&t.options.crs.code){var i=t.options.crs.code.split(":")[1];this.options.bboxSR=i,this.options.imageSR=i}t.on("moveend",this._update,this),this._currentImage&&this._currentImage._bounds.equals(this._map.getBounds())?t.addLayer(this._currentImage):this._currentImage&&(this._map.removeLayer(this._currentImage),this._currentImage=null),this._update(),this._popup&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this))},bindPopup:function(t,i){return this._shouldRenderPopup=!1,this._lastClick=!1,this._popup=e.popup(i),this._popupFunction=t,this._map&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this)),this},unbindPopup:function(){return this._map&&(this._map.closePopup(this._popup),this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._popup=!1,this},onRemove:function(e){this._currentImage&&this._map.removeLayer(this._currentImage),this._popup&&(this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._map.off("moveend",this._update,this),this._map=null},addTo:function(e){return e.addLayer(this),this},removeFrom:function(e){return e.removeLayer(this),this},bringToFront:function(){return this.options.position="front",this._currentImage&&this._currentImage.bringToFront(),this},bringToBack:function(){return this.options.position="back",this._currentImage&&this._currentImage.bringToBack(),this},getAttribution:function(){return this.options.attribution},getOpacity:function(){return this.options.opacity},setOpacity:function(e){return this.options.opacity=e,this._currentImage.setOpacity(e),this},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(e,t){return this.options.from=e,this.options.to=t,this._update(),this},metadata:function(e,t){return this._service.metadata(e,t),this},authenticate:function(e){return this._service.authenticate(e),this},_renderImage:function(t,i){if(this._map){new e.ImageOverlay(t,i,{opacity:0}).addTo(this._map).once("load",function(e){var t=e.target,s=this._currentImage;t._bounds.equals(i)&&t._bounds.equals(this._map.getBounds())?(this._currentImage=t,"front"===this.options.position?this.bringToFront():this.bringToBack(),this._map&&this._currentImage._map?this._currentImage.setOpacity(this.options.opacity):this._currentImage._map.removeLayer(this._currentImage),s&&this._map&&this._map.removeLayer(s),s&&s._map&&s._map.removeLayer(s)):this._map.removeLayer(t),this.fire("load",{bounds:i})},this),this.fire("loading",{bounds:i})}},_update:function(){if(this._map){var e=this._map.getZoom(),t=this._map.getBounds();if(!this._animatingZoom&&!(this._map._panTransition&&this._map._panTransition._inProgress||e>this.options.maxZoom||e<this.options.minZoom)){var i=this._buildExportParams();this._requestExport(i,t)}}},_renderPopup:function(t,i,s,r){if(t=e.latLng(t),this._shouldRenderPopup&&this._lastClick.equals(t)){var o=this._popupFunction(i,s,r);o&&this._popup.setLatLng(t).setContent(o).openOn(this._map)}},_resetPopupState:function(e){this._shouldRenderPopup=!1,this._lastClick=e.latlng},_propagateEvent:function(t){t=e.extend({layer:t.target,target:this},t),this.fire(t.type,t)}}),t.Layers.DynamicMapLayer=t.Layers.RasterLayer.extend({options:{updateInterval:150,layers:!1,layerDefs:!1,timeOptions:!1,format:"png24",transparent:!0,f:"json"},initialize:function(i){i.url=t.Util.cleanUrl(i.url),this._service=new t.Services.MapService(i),this._service.on("authenticationrequired requeststart requestend requesterror requestsuccess",this._propagateEvent,this),(i.proxy||i.token)&&"json"!==i.f&&(i.f="json"),e.Util.setOptions(this,i)},getDynamicLayers:function(){return this.options.dynamicLayers},setDynamicLayers:function(e){return this.options.dynamicLayers=e,this._update(),this},getLayers:function(){return this.options.layers},setLayers:function(e){return this.options.layers=e,this._update(),this},getLayerDefs:function(){return this.options.layerDefs},setLayerDefs:function(e){return this.options.layerDefs=e,this._update(),this},getTimeOptions:function(){return this.options.timeOptions},setTimeOptions:function(e){return this.options.timeOptions=e,this._update(),this},query:function(){return this._service.query()},identify:function(){return this._service.identify()},find:function(){return this._service.find()},_getPopupData:function(t){var i=e.Util.bind(function(i,s,r){i||setTimeout(e.Util.bind(function(){this._renderPopup(t.latlng,i,s,r)},this),300)},this),s=this.identify().on(this._map).at(t.latlng);this.options.layers?s.layers("visible:"+this.options.layers.join(",")):s.layers("visible"),s.run(i),this._shouldRenderPopup=!0,this._lastClick=t.latlng},_buildExportParams:function(){var e=this._map.getBounds(),t=this._map.getSize(),i=this._map.options.crs.project(e._northEast),s=this._map.options.crs.project(e._southWest),r=this._map.latLngToLayerPoint(e._northEast),o=this._map.latLngToLayerPoint(e._southWest);(r.y>0||o.y<t.y)&&(t.y=o.y-r.y);var n={bbox:[s.x,s.y,i.x,i.y].join(","),size:t.x+","+t.y,dpi:96,format:this.options.format,transparent:this.options.transparent,bboxSR:this.options.bboxSR,imageSR:this.options.imageSR};return this.options.dynamicLayers&&(n.dynamicLayers=this.options.dynamicLayers),this.options.layers&&(n.layers="show:"+this.options.layers.join(",")),
this.options.layerDefs&&(n.layerDefs=JSON.stringify(this.options.layerDefs)),this.options.timeOptions&&(n.timeOptions=JSON.stringify(this.options.timeOptions)),this.options.from&&this.options.to&&(n.time=this.options.from.valueOf()+","+this.options.to.valueOf()),this._service.options.token&&(n.token=this._service.options.token),n},_requestExport:function(t,i){"json"===this.options.f?this._service.request("export",t,function(e,t){e||this._renderImage(t.href,i)},this):(t.f="image",this._renderImage(this.options.url+"export"+e.Util.getParamString(t),i))}}),t.DynamicMapLayer=t.Layers.DynamicMapLayer,t.Layers.dynamicMapLayer=function(e){return new t.Layers.DynamicMapLayer(e)},t.dynamicMapLayer=function(e){return new t.Layers.DynamicMapLayer(e)},t.Layers.ImageMapLayer=t.Layers.RasterLayer.extend({options:{updateInterval:150,format:"jpgpng",transparent:!0,f:"json"},query:function(){return this._service.query()},identify:function(){return this._service.identify()},initialize:function(i){i.url=t.Util.cleanUrl(i.url),this._service=new t.Services.ImageService(i),this._service.on("authenticationrequired requeststart requestend requesterror requestsuccess",this._propagateEvent,this),e.Util.setOptions(this,i)},setPixelType:function(e){return this.options.pixelType=e,this._update(),this},getPixelType:function(){return this.options.pixelType},setBandIds:function(t){return e.Util.isArray(t)?this.options.bandIds=t.join(","):this.options.bandIds=t.toString(),this._update(),this},getBandIds:function(){return this.options.bandIds},setNoData:function(t,i){return e.Util.isArray(t)?this.options.noData=t.join(","):this.options.noData=t.toString(),i&&(this.options.noDataInterpretation=i),this._update(),this},getNoData:function(){return this.options.noData},getNoDataInterpretation:function(){return this.options.noDataInterpretation},setRenderingRule:function(e){this.options.renderingRule=e,this._update()},getRenderingRule:function(){return this.options.renderingRule},setMosaicRule:function(e){this.options.mosaicRule=e,this._update()},getMosaicRule:function(){return this.options.mosaicRule},_getPopupData:function(t){var i=e.Util.bind(function(i,s,r){i||setTimeout(e.Util.bind(function(){this._renderPopup(t.latlng,i,s,r)},this),300)},this),s=this.identify().at(t.latlng);this.options.mosaicRule&&s.setMosaicRule(this.options.mosaicRule),s.run(i),this._shouldRenderPopup=!0,this._lastClick=t.latlng},_buildExportParams:function(){var e=this._map.getBounds(),t=this._map.getSize(),i=this._map.options.crs.project(e._northEast),s=this._map.options.crs.project(e._southWest),r={bbox:[s.x,s.y,i.x,i.y].join(","),size:t.x+","+t.y,format:this.options.format,transparent:this.options.transparent,bboxSR:this.options.bboxSR,imageSR:this.options.imageSR};return this.options.from&&this.options.to&&(r.time=this.options.from.valueOf()+","+this.options.to.valueOf()),this.options.pixelType&&(r.pixelType=this.options.pixelType),this.options.interpolation&&(r.interpolation=this.options.interpolation),this.options.compressionQuality&&(r.compressionQuality=this.options.compressionQuality),this.options.bandIds&&(r.bandIds=this.options.bandIds),this.options.noData&&(r.noData=this.options.noData),this.options.noDataInterpretation&&(r.noDataInterpretation=this.options.noDataInterpretation),this._service.options.token&&(r.token=this._service.options.token),this.options.renderingRule&&(r.renderingRule=JSON.stringify(this.options.renderingRule)),this.options.mosaicRule&&(r.mosaicRule=JSON.stringify(this.options.mosaicRule)),r},_requestExport:function(t,i){"json"===this.options.f?this._service.request("exportImage",t,function(e,t){e||this._renderImage(t.href,i)},this):(t.f="image",this._renderImage(this.options.url+"exportImage"+e.Util.getParamString(t),i))}}),t.ImageMapLayer=t.Layers.ImageMapLayer,t.Layers.imageMapLayer=function(e){return new t.Layers.ImageMapLayer(e)},t.imageMapLayer=function(e){return new t.Layers.ImageMapLayer(e)},t.Layers.TiledMapLayer=e.TileLayer.extend({options:{zoomOffsetAllowance:.1,correctZoomLevels:!0},statics:{MercatorZoomLevels:{0:156543.033928,1:78271.5169639999,2:39135.7584820001,3:19567.8792409999,4:9783.93962049996,5:4891.96981024998,6:2445.98490512499,7:1222.99245256249,8:611.49622628138,9:305.748113140558,10:152.874056570411,11:76.4370282850732,12:38.2185141425366,13:19.1092570712683,14:9.55462853563415,15:4.77731426794937,16:2.38865713397468,17:1.19432856685505,18:.597164283559817,19:.298582141647617,20:.14929107082381,21:.07464553541191,22:.0373227677059525,23:.0186613838529763}},initialize:function(i){i.url=t.Util.cleanUrl(i.url),i=e.Util.setOptions(this,i),this.tileUrl=e.esri.Util.cleanUrl(i.url)+"tile/{z}/{y}/{x}",this._service=new e.esri.Services.MapService(i),this._service.on("authenticationrequired requeststart requestend requesterror requestsuccess",this._propagateEvent,this),this.tileUrl.match("://tiles.arcgisonline.com")&&(this.tileUrl=this.tileUrl.replace("://tiles.arcgisonline.com","://tiles{s}.arcgisonline.com"),i.subdomains=["1","2","3","4"]),this.options.token&&(this.tileUrl+="?token="+this.options.token),e.TileLayer.prototype.initialize.call(this,this.tileUrl,i)},getTileUrl:function(t){return e.Util.template(this.tileUrl,e.extend({s:this._getSubdomain(t),z:this._lodMap[t.z]||t.z,x:t.x,y:t.y},this.options))},onAdd:function(i){!this._lodMap&&this.options.correctZoomLevels?(this._lodMap={},this.metadata(function(s,r){if(!s){var o=r.spatialReference.latestWkid||r.spatialReference.wkid;if(102100===o||3857===o)for(var n=r.tileInfo.lods,a=t.Layers.TiledMapLayer.MercatorZoomLevels,u=0;u<n.length;u++){var l=n[u];for(var h in a){var c=a[h];if(this._withinPercentage(l.resolution,c,this.options.zoomOffsetAllowance)){this._lodMap[h]=l.level;break}}}else t.Util.warn("L.esri.TiledMapLayer is using a non-mercator spatial reference. Support may be available through Proj4Leaflet http://esri.github.io/esri-leaflet/examples/non-mercator-projection.html")}e.TileLayer.prototype.onAdd.call(this,i)},this)):e.TileLayer.prototype.onAdd.call(this,i)},metadata:function(e,t){return this._service.metadata(e,t),this},identify:function(){return this._service.identify()},authenticate:function(e){var t="?token="+e;return this.tileUrl=this.options.token?this.tileUrl.replace(/\?token=(.+)/g,t):this.tileUrl+t,this.options.token=e,this._service.authenticate(e),this},_propagateEvent:function(t){t=e.extend({layer:t.target,target:this},t),this.fire(t.type,t)},_withinPercentage:function(e,t,i){return Math.abs(e/t-1)<i}}),e.esri.TiledMapLayer=e.esri.Layers.tiledMapLayer,e.esri.Layers.tiledMapLayer=function(t){return new e.esri.Layers.TiledMapLayer(t)},e.esri.tiledMapLayer=function(t){return new e.esri.Layers.TiledMapLayer(t)},t.Layers.FeatureGrid=e.Class.extend({includes:e.Mixin.Events,options:{cellSize:512,updateInterval:150},initialize:function(t){t=e.setOptions(this,t)},onAdd:function(t){this._map=t,this._update=e.Util.limitExecByInterval(this._update,this.options.updateInterval,this),this._map.addEventListener(this.getEvents(),this),this._reset(),this._update()},onRemove:function(){this._map.removeEventListener(this.getEvents(),this),this._removeCells()},getEvents:function(){return{viewreset:this._reset,moveend:this._update,zoomend:this._onZoom}},addTo:function(e){return e.addLayer(this),this},removeFrom:function(e){return e.removeLayer(this),this},_onZoom:function(){var e=this._map.getZoom();e>this.options.maxZoom||e<this.options.minZoom?(this.removeFrom(this._map),this._map.addEventListener("zoomend",this.getEvents().zoomend,this)):this._map.hasLayer(this)||(this._map.removeEventListener("zoomend",this.getEvents().zoomend,this),this.addTo(this._map))},_reset:function(){this._removeCells(),this._cells={},this._activeCells={},this._cellsToLoad=0,this._cellsTotal=0,this._resetWrap()},_resetWrap:function(){var e=this._map,t=e.options.crs;if(!t.infinite){var i=this._getCellSize();t.wrapLng&&(this._wrapLng=[Math.floor(e.project([0,t.wrapLng[0]]).x/i),Math.ceil(e.project([0,t.wrapLng[1]]).x/i)]),t.wrapLat&&(this._wrapLat=[Math.floor(e.project([t.wrapLat[0],0]).y/i),Math.ceil(e.project([t.wrapLat[1],0]).y/i)])}},_getCellSize:function(){return this.options.cellSize},_update:function(){if(this._map){var t=this._map.getPixelBounds(),i=this._map.getZoom(),s=this._getCellSize(),r=[s/2,s/2];if(!(i>this.options.maxZoom||i<this.options.minZoom)){var o=t.min.subtract(r).divideBy(s).floor();o.x=Math.max(o.x,0),o.y=Math.max(o.y,0);var n=e.bounds(o,t.max.add(r).divideBy(s).floor());this._removeOtherCells(n),this._addCells(n)}}},_addCells:function(t){var i,s,r,o=[],n=t.getCenter(),a=this._map.getZoom();for(i=t.min.y;i<=t.max.y;i++)for(s=t.min.x;s<=t.max.x;s++)r=new e.Point(s,i),r.z=a,o.push(r);var u=o.length;if(0!==u)for(this._cellsToLoad+=u,this._cellsTotal+=u,o.sort(function(e,t){return e.distanceTo(n)-t.distanceTo(n)}),s=0;s<u;s++)this._addCell(o[s])},_cellCoordsToBounds:function(t){var i=this._map,s=this.options.cellSize,r=t.multiplyBy(s),o=r.add([s,s]),n=i.unproject(r,t.z).wrap(),a=i.unproject(o,t.z).wrap();return new e.LatLngBounds(n,a)},_cellCoordsToKey:function(e){return e.x+":"+e.y},_keyToCellCoords:function(t){var i=t.split(":"),s=parseInt(i[0],10),r=parseInt(i[1],10);return new e.Point(s,r)},_removeOtherCells:function(e){for(var t in this._cells)e.contains(this._keyToCellCoords(t))||this._removeCell(t)},_removeCell:function(e){var t=this._activeCells[e];t&&(delete this._activeCells[e],this.cellLeave&&this.cellLeave(t.bounds,t.coords),this.fire("cellleave",{bounds:t.bounds,coords:t.coords}))},_removeCells:function(){for(var e in this._cells){var t=this._cells[e].bounds,i=this._cells[e].coords;this.cellLeave&&this.cellLeave(t,i),this.fire("cellleave",{bounds:t,coords:i})}},_addCell:function(e){this._wrapCoords(e);var t=this._cellCoordsToKey(e),i=this._cells[t];i&&!this._activeCells[t]&&(this.cellEnter&&this.cellEnter(i.bounds,e),this.fire("cellenter",{bounds:i.bounds,coords:e}),this._activeCells[t]=i),i||(i={coords:e,bounds:this._cellCoordsToBounds(e)},this._cells[t]=i,this._activeCells[t]=i,this.createCell&&this.createCell(i.bounds,e),this.fire("cellcreate",{bounds:i.bounds,coords:e}))},_wrapCoords:function(t){t.x=this._wrapLng?e.Util.wrapNum(t.x,this._wrapLng):t.x,t.y=this._wrapLat?e.Util.wrapNum(t.y,this._wrapLat):t.y}}),function(t){function i(e){this.values=e||[]}t.Layers.FeatureManager=t.Layers.FeatureGrid.extend({options:{where:"1=1",fields:["*"],from:!1,to:!1,timeField:!1,timeFilterMode:"server",simplifyFactor:0,precision:6},initialize:function(s){if(t.Layers.FeatureGrid.prototype.initialize.call(this,s),s.url=t.Util.cleanUrl(s.url),s=e.setOptions(this,s),this._service=new t.Services.FeatureLayerService(s),"*"!==this.options.fields[0]){for(var r=!1,o=0;o<this.options.fields.length;o++)this.options.fields[o].match(/^(OBJECTID|FID|OID|ID)$/i)&&(r=!0);!1===r&&t.Util.warn("no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.")}this._service.on("authenticationrequired requeststart requestend requesterror requestsuccess",function(t){t=e.extend({target:this},t),this.fire(t.type,t)},this),this.options.timeField.start&&this.options.timeField.end?(this._startTimeIndex=new i,this._endTimeIndex=new i):this.options.timeField&&(this._timeIndex=new i),this._cache={},this._currentSnapshot=[],this._activeRequests=0,this._pendingRequests=[]},onAdd:function(e){return t.Layers.FeatureGrid.prototype.onAdd.call(this,e)},onRemove:function(e){return t.Layers.FeatureGrid.prototype.onRemove.call(this,e)},getAttribution:function(){return this.options.attribution},createCell:function(e,t){this._requestFeatures(e,t)},_requestFeatures:function(i,s,r){this._activeRequests++,1===this._activeRequests&&this.fire("loading",{bounds:i}),this._buildQuery(i).run(function(o,n,a){a&&a.exceededTransferLimit&&this.fire("drawlimitexceeded"),!o&&n&&n.features.length&&t.Util.requestAnimationFrame(e.Util.bind(function(){this._addFeatures(n.features,s),this._postProcessFeatures(i)},this)),o||!n||n.features.length||this._postProcessFeatures(i),r&&r.call(this,o,n)},this)},_postProcessFeatures:function(e){--this._activeRequests<=0&&this.fire("load",{bounds:e})},_cacheKey:function(e){return e.z+":"+e.x+":"+e.y},_addFeatures:function(e,t){var i=this._cacheKey(t);this._cache[i]=this._cache[i]||[];for(var s=e.length-1;s>=0;s--){var r=e[s].id;this._currentSnapshot.push(r),this._cache[i].push(r)}this.options.timeField&&this._buildTimeIndexes(e);var o=this._map.getZoom();o>this.options.maxZoom||o<this.options.minZoom||this.createLayers(e)},_buildQuery:function(e){var t=this._service.query().intersects(e).where(this.options.where).fields(this.options.fields).precision(this.options.precision);return this.options.simplifyFactor&&t.simplify(this._map,this.options.simplifyFactor),"server"===this.options.timeFilterMode&&this.options.from&&this.options.to&&t.between(this.options.from,this.options.to),t},setWhere:function(i,s,r){this.options.where=i&&i.length?i:"1=1";for(var o=[],n=[],a=0,u=null,l=e.Util.bind(function(i,l){if(a--,i&&(u=i),l)for(var h=l.features.length-1;h>=0;h--)n.push(l.features[h].id);a<=0&&(this._currentSnapshot=n,t.Util.requestAnimationFrame(e.Util.bind(function(){this.removeLayers(o),this.addLayers(n),s&&s.call(r,u)},this)))},this),h=this._currentSnapshot.length-1;h>=0;h--)o.push(this._currentSnapshot[h]);for(var c in this._activeCells){a++;var p=this._keyToCellCoords(c),d=this._cellCoordsToBounds(p);this._requestFeatures(d,c,l)}return this},getWhere:function(){return this.options.where},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(t,i,s,r){var o=this.options.from,n=this.options.to,a=0,u=null,l=e.Util.bind(function(e){e&&(u=e),this._filterExistingFeatures(o,n,t,i),a--,s&&a<=0&&s.call(r,u)},this);if(this.options.from=t,this.options.to=i,this._filterExistingFeatures(o,n,t,i),"server"===this.options.timeFilterMode)for(var h in this._activeCells){a++;var c=this._keyToCellCoords(h),p=this._cellCoordsToBounds(c);this._requestFeatures(p,h,l)}},refresh:function(){for(var e in this._activeCells){var t=this._keyToCellCoords(e),i=this._cellCoordsToBounds(t);this._requestFeatures(i,e)}this.redraw&&this.once("load",function(){this.eachFeature(function(e){this._redraw(e.feature.id)},this)},this)},_filterExistingFeatures:function(i,s,r,o){var n=i&&s?this._getFeaturesInTimeRange(i,s):this._currentSnapshot,a=this._getFeaturesInTimeRange(r,o);if(a.indexOf)for(var u=0;u<a.length;u++){var l=n.indexOf(a[u]);l>=0&&n.splice(l,1)}t.Util.requestAnimationFrame(e.Util.bind(function(){this.removeLayers(n),this.addLayers(a)},this))},_getFeaturesInTimeRange:function(e,t){var i,s=[];if(this.options.timeField.start&&this.options.timeField.end){var r=this._startTimeIndex.between(e,t),o=this._endTimeIndex.between(e,t);i=r.concat(o)}else i=this._timeIndex.between(e,t);for(var n=i.length-1;n>=0;n--)s.push(i[n].id);return s},_buildTimeIndexes:function(e){var t,i;if(this.options.timeField.start&&this.options.timeField.end){var s=[],r=[];for(t=e.length-1;t>=0;t--)i=e[t],s.push({id:i.id,value:new Date(i.properties[this.options.timeField.start])}),r.push({id:i.id,value:new Date(i.properties[this.options.timeField.end])});this._startTimeIndex.bulkAdd(s),this._endTimeIndex.bulkAdd(r)}else{var o=[];for(t=e.length-1;t>=0;t--)i=e[t],o.push({id:i.id,value:new Date(i.properties[this.options.timeField])});this._timeIndex.bulkAdd(o)}},_featureWithinTimeRange:function(e){if(!this.options.from||!this.options.to)return!0;var t=+this.options.from.valueOf(),i=+this.options.to.valueOf();if("string"==typeof this.options.timeField){var s=+e.properties[this.options.timeField];return s>=t&&s<=i}if(this.options.timeField.start&&this.options.timeField.end){var r=+e.properties[this.options.timeField.start],o=+e.properties[this.options.timeField.end];return r>=t&&r<=i||o>=t&&o<=i}},authenticate:function(e){return this._service.authenticate(e),this},metadata:function(e,t){return this._service.metadata(e,t),this},query:function(){return this._service.query()},_getMetadata:function(t){if(this._metadata){t(void 0,this._metadata)}else this.metadata(e.Util.bind(function(e,i){this._metadata=i,t(e,this._metadata)},this))},addFeature:function(t,i,s){this._getMetadata(e.Util.bind(function(r,o){this._service.addFeature(t,e.Util.bind(function(e,r){e||(t.properties[o.objectIdField]=r.objectId,t.id=r.objectId,this.createLayers([t])),i&&i.call(s,e,r)},this))},this))},updateFeature:function(e,t,i){this._service.updateFeature(e,function(s,r){s||(this.removeLayers([e.id],!0),this.createLayers([e])),t&&t.call(i,s,r)},this)},deleteFeature:function(e,t,i){this._service.deleteFeature(e,function(e,s){!e&&s.objectId&&this.removeLayers([s.objectId],!0),t&&t.call(i,e,s)},this)},deleteFeatures:function(e,t,i){return this._service.deleteFeatures(e,function(e,s){if(!e&&s.length>0)for(var r=0;r<s.length;r++)this.removeLayers([s[r].objectId],!0);t&&t.call(i,e,s)},this)}}),i.prototype._query=function(e){for(var t,i,s=0,r=this.values.length-1;s<=r;)if(t=(s+r)/2|0,i=this.values[Math.round(t)],+i.value<+e)s=t+1;else{if(!(+i.value>+e))return t;r=t-1}return~r},i.prototype.sort=function(){this.values.sort(function(e,t){return+t.value-+e.value}).reverse(),this.dirty=!1},i.prototype.between=function(e,t){this.dirty&&this.sort();var i=this._query(e),s=this._query(t);return 0===i&&0===s?[]:(i=Math.abs(i),s=s<0?Math.abs(s):s+1,this.values.slice(i,s))},i.prototype.bulkAdd=function(e){this.dirty=!0,this.values=this.values.concat(e)}}(t),t.Layers.FeatureLayer=t.Layers.FeatureManager.extend({statics:{EVENTS:"click dblclick mouseover mouseout mousemove contextmenu popupopen popupclose"},options:{cacheLayers:!0},initialize:function(i){t.Layers.FeatureManager.prototype.initialize.call(this,i),i=e.setOptions(this,i),this._layers={},this._leafletIds={},this._key="c"+(1e9*Math.random()).toString(36).replace(".","_")},onAdd:function(e){return e.on("zoomstart zoomend",function(e){this._zooming="zoomstart"===e.type},this),t.Layers.FeatureManager.prototype.onAdd.call(this,e)},onRemove:function(e){for(var i in this._layers)e.removeLayer(this._layers[i]);return t.Layers.FeatureManager.prototype.onRemove.call(this,e)},createNewLayer:function(t){return e.GeoJSON.geometryToLayer(t,this.options.pointToLayer,e.GeoJSON.coordsToLatLng,this.options)},_updateLayer:function(t,i){var s=[],r=this.options.coordsToLatLng||e.GeoJSON.coordsToLatLng;switch(i.properties&&(t.feature.properties=i.properties),i.geometry.type){case"Point":s=e.GeoJSON.coordsToLatLng(i.geometry.coordinates),t.setLatLng(s);break;case"LineString":s=e.GeoJSON.coordsToLatLngs(i.geometry.coordinates,0,r),t.setLatLngs(s);break;case"MultiLineString":case"Polygon":s=e.GeoJSON.coordsToLatLngs(i.geometry.coordinates,1,r),t.setLatLngs(s);break;case"MultiPolygon":s=e.GeoJSON.coordsToLatLngs(i.geometry.coordinates,2,r),t.setLatLngs(s)}},createLayers:function(e){for(var i=e.length-1;i>=0;i--){var s,r=e[i],o=this._layers[r.id];o&&!this._map.hasLayer(o)&&this._map.addLayer(o),o&&(o.setLatLngs||o.setLatLng)&&this._updateLayer(o,r),o||(s=this.createNewLayer(r),s.feature=r,this.options.style?s._originalStyle=this.options.style:s.setStyle&&(s._originalStyle=s.options),s._leaflet_id=this._key+"_"+r.id,this._leafletIds[s._leaflet_id]=r.id,s.on(t.Layers.FeatureLayer.EVENTS,this._propagateEvent,this),this._popup&&s.bindPopup&&s.bindPopup(this._popup(s.feature,s),this._popupOptions),this.options.onEachFeature&&this.options.onEachFeature(s.feature,s),this._layers[s.feature.id]=s,this.resetStyle(s.feature.id),this.fire("createfeature",{feature:s.feature}),(!this.options.timeField||this.options.timeField&&this._featureWithinTimeRange(r))&&this._map.addLayer(s))}},addLayers:function(e){for(var t=e.length-1;t>=0;t--){var i=this._layers[e[t]];i&&(this.fire("addfeature",{feature:i.feature}),this._map.addLayer(i))}},removeLayers:function(e,t){for(var i=e.length-1;i>=0;i--){var s=e[i],r=this._layers[s];r&&(this.fire("removefeature",{feature:r.feature,permanent:t}),this._map.removeLayer(r)),r&&t&&delete this._layers[s]}},cellEnter:function(i,s){this._zooming||t.Util.requestAnimationFrame(e.Util.bind(function(){var e=this._cacheKey(s),t=this._cellCoordsToKey(s),i=this._cache[e];this._activeCells[t]&&i&&this.addLayers(i)},this))},cellLeave:function(i,s){this._zooming||t.Util.requestAnimationFrame(e.Util.bind(function(){var e=this._cacheKey(s),t=this._cellCoordsToKey(s),i=this._cache[e],r=this._map.getBounds();if(!this._activeCells[t]&&i){for(var o=!0,n=0;n<i.length;n++){var a=this._layers[i[n]];a&&a.getBounds&&r.intersects(a.getBounds())&&(o=!1)}o&&this.removeLayers(i,!this.options.cacheLayers),!this.options.cacheLayers&&o&&(delete this._cache[e],delete this._cells[t],delete this._activeCells[t])}},this))},resetStyle:function(e){var t=this._layers[e];return t&&this.setFeatureStyle(t.feature.id,t._originalStyle),this},setStyle:function(e){return this.options.style=e,this.eachFeature(function(t){this.setFeatureStyle(t.feature.id,e)},this),this},setFeatureStyle:function(t,i){var s=this._layers[t];return"function"==typeof i&&(i=i(s.feature)),i||s.defaultOptions||(i=e.Path.prototype.options,i.fill=!0),s&&s.setStyle&&s.setStyle(i),this},bindPopup:function(e,t){this._popup=e,this._popupOptions=t;for(var i in this._layers){var s=this._layers[i],r=this._popup(s.feature,s);s.bindPopup(r,t)}return this},unbindPopup:function(){this._popup=!1;for(var e in this._layers){var t=this._layers[e];if(t.unbindPopup)t.unbindPopup();else if(t.getLayers){var i=t.getLayers();for(var s in i){var r=i[s];r.unbindPopup()}}}return this},eachFeature:function(e,t){for(var i in this._layers)e.call(t,this._layers[i]);return this},getFeature:function(e){return this._layers[e]},bringToBack:function(){this.eachFeature(function(e){e.bringToBack&&e.bringToBack()})},bringToFront:function(){this.eachFeature(function(e){e.bringToFront&&e.bringToFront()})},redraw:function(e){return e&&this._redraw(e),this},_redraw:function(t){var i=this._layers[t],s=i.feature;if(i&&i.setIcon&&this.options.pointToLayer&&this.options.pointToLayer){var r=this.options.pointToLayer(s,e.latLng(s.geometry.coordinates[1],s.geometry.coordinates[0])),o=r.options.icon;i.setIcon(o)}if(i&&i.setStyle&&this.options.pointToLayer){var n=this.options.pointToLayer(s,e.latLng(s.geometry.coordinates[1],s.geometry.coordinates[0])),a=n.options;this.setFeatureStyle(s.id,a)}i&&i.setStyle&&this.options.style&&this.resetStyle(s.id)},_propagateEvent:function(e){e.layer=this._layers[this._leafletIds[e.target._leaflet_id]],e.target=this,this.fire(e.type,e)}}),t.FeatureLayer=t.Layers.FeatureLayer,t.Layers.featureLayer=function(e){return new t.Layers.FeatureLayer(e)},t.featureLayer=function(e){return new t.Layers.FeatureLayer(e)},t.Controls.Logo=e.Control.extend({options:{position:"bottomright",marginTop:0,marginLeft:0,marginBottom:0,marginRight:0},onAdd:function(){var t=e.DomUtil.create("div","esri-leaflet-logo");return t.style.marginTop=this.options.marginTop,t.style.marginLeft=this.options.marginLeft,t.style.marginBottom=this.options.marginBottom,t.style.marginRight=this.options.marginRight,t.innerHTML=this._adjustLogo(this._map._size),this._map.on("resize",function(e){t.innerHTML=this._adjustLogo(e.newSize)},this),t},_adjustLogo:function(e){return e.x<=600||e.y<=600?'<a href="https://developers.arcgis.com" style="border: none;"><img src="https://js.arcgis.com/3.13/esri/images/map/logo-sm.png" alt="Powered by Esri" style="border: none;"></a>':'<a href="https://developers.arcgis.com" style="border: none;"><img src="https://js.arcgis.com/3.13/esri/images/map/logo-med.png" alt="Powered by Esri" style="border: none;"></a>'}}),t.Controls.logo=function(t){return new e.esri.Controls.Logo(t)},t});